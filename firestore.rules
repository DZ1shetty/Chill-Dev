rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null; // Allow reading other users' profiles for display purposes
    }
    
    // Reports collection
    match /reports/{reportId} {
      // Anyone can read reports (public safety information)
      allow read: if true;
      
      // Any authenticated user can create reports
      allow create: if request.auth != null 
        && request.auth.uid != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && request.resource.data.keys().hasAll(['type', 'description', 'latitude', 'longitude', 'userId', 'userDisplayName', 'createdAt', 'updatedAt'])
        && request.resource.data.type in ['safe', 'unsafe']
        && request.resource.data.description is string
        && request.resource.data.description.size() > 0
        && request.resource.data.description.size() <= 1000
        && request.resource.data.latitude is number
        && request.resource.data.longitude is number
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userDisplayName is string
        && request.resource.data.createdAt is timestamp
        && request.resource.data.updatedAt is timestamp;
      
      // Only the report author can update their own reports
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.userId
        && request.resource.data.keys().hasAll(['type', 'description', 'latitude', 'longitude', 'userId', 'userDisplayName', 'createdAt', 'updatedAt'])
        && request.resource.data.type in ['safe', 'unsafe']
        && request.resource.data.description is string
        && request.resource.data.description.size() > 0
        && request.resource.data.description.size() <= 1000
        && request.resource.data.latitude is number
        && request.resource.data.longitude is number
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userDisplayName is string
        && request.resource.data.createdAt == resource.data.createdAt // Prevent modification of creation timestamp
        && request.resource.data.updatedAt is timestamp;
      
      // Only the report author can delete their own reports
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
  }
}
